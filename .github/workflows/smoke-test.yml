name: Smoke test - API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    name: smoke-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Create venv and install requirements
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Start Flask app (background)
        env:
          FLASK_TEST_MODE: 'true'
        run: |
          . .venv/bin/activate
          nohup ./.venv/bin/python flask_app.py --port=5050 > dashboard.log 2>&1 &
          echo $! > dashboard.pid
          sleep 2
          # Check if process is still running
          if ! kill -0 $(cat dashboard.pid) 2>/dev/null; then
            echo "Flask app failed to start" >&2
            cat dashboard.log
            exit 1
          fi

      - name: Wait for Flask to start (health check)
        run: |
          elapsed=0
          max_wait=10
          code=000
          while [ $elapsed -lt $max_wait ]; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:5050/health || echo 000)
            if [ "$code" = "200" ]; then
              echo "Flask health check passed after ${elapsed}s"
              break
            fi
            sleep 1
            elapsed=$((elapsed + 1))
          done
          if [ "$code" != "200" ]; then
            echo "Flask did not start after ${max_wait}s" >&2
            cat dashboard.log
            exit 1
          fi

      - name: Wait for /api/analysis (timeout 10s)
        run: |
          elapsed=0
          max_wait=10
          code=000
          while [ $elapsed -lt $max_wait ]; do
            code=$(curl -s -o /tmp/api.json -w "%{http_code}" http://127.0.0.1:5050/api/analysis || echo 000)
            if [ "$code" = "200" ]; then
              echo "API responded with 200 after ${elapsed}s"
              break
            fi
            sleep 1
            elapsed=$((elapsed + 1))
          done
          if [ "$code" != "200" ]; then
            echo "API did not respond after ${max_wait}s (last HTTP code: $code)" >&2
            echo "--- dashboard.log ---"
            tail -n 200 dashboard.log || true
            echo "--- /tmp/api.json ---"
            cat /tmp/api.json || true
            exit 1
          fi

      - name: Validate JSON payload contains expected keys
        run: |
          # basic check that payload is valid JSON and contains top-level keys
          cat /tmp/api.json | python -c "import sys,json; d=json.load(sys.stdin); assert 'bias_5m' in d and 'bias_15m' in d; print('payload ok')"

      - name: Cleanup
        if: always()
        run: |
          if [ -f dashboard.pid ]; then
            kill "$(cat dashboard.pid)" || true
            rm -f dashboard.pid
          fi
          echo 'done'
